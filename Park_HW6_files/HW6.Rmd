---
title:  'Homework 6'
subtitle: 'ISTA 421/INFO 521'
author:
- name: Student - Jung Mee Park
  affiliation: University of Arizona
- name: Instructor -  Cristian Roman-Palacios
  affiliation: School of Information, University of Arizona, Tucson, AZ
tags: [R, RStudio, HW6]
output: html_document
---

---------------

### Objectives
This homework sheet will help reviewing the basic concepts associated with non-linear models. Please review the lectures, suggested readings, and additional resources _before_ getting started on the HW.

---------------

#### Additional resources relevant to this HW

- __R Markdown__: Please review the basic R Markdown cheat sheet in case you have any questions regarding formatting the HW: https://www.rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf.

- __R__: Please review the basic R` cheat sheet in case you have any questions regarding the programming language: https://www.soa.org/globalassets/assets/Files/Edu/2018/exam-pa-base-r.pdf.

- __RStudio__: Additional cheat sheets written by RStudio to help with specific `R` packages: https://www.rstudio.com/resources/cheatsheets/

- __Datasets__: The following website has access to the relevant datasets from the recommended textbook: https://book.huihoo.com/introduction-to-statistical-learning/data.html


#### The *Tidyverse*

I encourage students to check out functions from packages included in the `tidyverse` (https://www.tidyverse.org/) which greatly facilitates the productivity of novice coders. However, all instructions will be delivered using `Base` `R`. The main textbook also uses base `R` only. I will be happy to grade your code regardless whether it uses base `R` or functions in the `tidyverse.` For some steps, other packages (such as `data.table`) are an appropriate alternative. Most if not all the questions in this HW can be answered using the tidyverse. Please check out the “accompanying” book to our main textbook that uses packages from the tidyverse instead of base (https://emilhvitfeldt.github.io/ISLR-tidymodels-labs/index.html). For this chapter, please follow the instructions in the following site: https://emilhvitfeldt.github.io/ISLR-tidymodels-labs/linear-regression.html. 



### Scores

Please answer the questions from the section that you’re enrolled in (labeled as either __421__ or __521__). Below is a summary of the total scores associated with this HW (2 points per question).


- __ISTA 421__: 14 points (undergraduate)
- __INFO 521__: 16 points (graduate)

### Submission:
Please follow the instructions outlined below to submit your assignment. __This HW is due at the end of the same week that is released (Sunday, 11:59 pm AZ time)__. Please get in touch with the instructor if you’re (i) having issues opening the assignment, (2) not understanding the questions or (3) having issues submitting your assignment. Note that late submissions are subject to a penalty (see late work policies in the Syllabus).


-**Homework 6**: Please turn in a __single RMD file (this file) AND a rendered HTML__. Answers to each question should be in the relevant block of code (see below). Re-name your file to __lastname_Hw6.RMD__ before submitting. __Make sure that you can correctly render (knit) your submission without errors before turning anything in__. If a given block of code is causing you issues and you didn’t get to fix it on time, please use `eval=FALSE` in the relevant block. If you’re using additional files to render your __RMD__, please include each of them in your submission.


### Time commitment
Please do reach out if you’re taking more than ~18h to complete (1) this HW, (2) reading the assigned book chapters, and (3) going over the lectures. I will be happy to provide accommodations if necessary. Do not wait until the last minute to start working on the HW. In most cases, working under pressure will certainly increase the time needed to answer each of these questions. The instructor might not be 100% available on Sundays to troubleshoot with you. Remember that you can sign up for office hours with the instructor 3 times a week.

### Looking for help?
First, please go over the relevant readings for this week. Second, if you’re still struggling with any of the questions, do some independent research (e.g. stackoverflow is a wonderful resource). __Don’t forget that your classmates will also be working on the same questions - reach out for help (check the Discussion forum in D2L for advice from other students)__. Finally, the instructor will be happy to answer any questions during office hours. You can reach out to me by email (cromanpa94@arizona.edu) or simply schedule a 15 minute meeting through Calendly (https://calendly.com/cromanpa/15min)*

Please do not forget that the instructor holds office hours 3 times a week!!


### Grading
_Please note that grades are NOT exclusively based on your final answers_. I will be grading the overall structure and logic of your code. Feel free to use as many lines as you need to answer each of the questions. I also highly recommend and strongly encourage adding comments (`#`) to your code. Comments will certainly improve the reproducibility and readability of your submission. Commenting your code is also good coding practice. Specifically for the course, you’ll get better feedback if the instructor is able to understand your code in detail.


---------------

# Questions

## Conceptual

#### Question 1 (421/521)

Suppose that a curve $\hat{g}$ is computed to smoothly fit a set of `n` points using the following formula:

  $$
  \hat{g} = \arg\min_{g}(\sum_{i=1}^n (y_i - g(x_i))^2 +  \lambda \int [g^{(m)} (x)]^2 dx )
  $$
where $g^{(m)}$  represents the $m^{th}$ derivative of $g$ (and $g^{(0)} = g$. Provide a description (or sketch) of $\hat{g}$ in each of the following scenarios. **Again, don't forget that $m^{th}$ is related to the derivative of $g$**.

  (a) $\lambda$ = $\infty$, $m = 0$.
  
  > **_Answer:_**  [BEGIN SOLUTION].
  
  (b) $\lambda$ = $\infty$, $m = 1$.
  
  > **_Answer:_**  [BEGIN SOLUTION].
  
  (c) $\lambda$ = $\infty$, $m = 2$.
  
  > **_Answer:_**  [BEGIN SOLUTION].
  
  (d) $\lambda$ = $\infty$, $m = 3$.
  
  > **_Answer:_**  [BEGIN SOLUTION].
  
  (e) $\lambda$ = 0, $m = 3$.
  
  > **_Answer:_**  [BEGIN SOLUTION].

#### Question 2 (421/521)

For (1) step functions, (2) local regression, and (3) GAMs: provide one situation when using that particular model is advantageous. For instance, “GAMs is likely the preferred option when the question I’m interested in addressing involves…”. 

> **_Answer:_**  [BEGIN SOLUTION].

#### Question 3 (421/521)

Define the following types of smooth functions (one or two sentences per each; following the notation of `mgcv`) and list at least one relevant potential use: `s()`, `te()`, `ti()`.


a) `s()`

> **_Answer:_**  [BEGIN SOLUTION].

b) `te()`

> **_Answer:_**  [BEGIN SOLUTION].

c) `ti()`

> **_Answer:_**  [BEGIN SOLUTION].


#### Question 4 (421/521)

In the context of GAMs, if `te(X1,X2)` models `f1(X1)+f2(X2)+f3(X1,X2)`, what does `ti(X1,X2)` model? Explain.

> **_Answer:_**  [BEGIN SOLUTION].


#### Question 5 (421/521)

Briefly explain what spatial and temporal autocorrelation are? List one way in which GAMs could help to account for this (e.g. indicate the type of smooth function you would use or potential types of correlation structures).

> **_Answer:_**  [BEGIN SOLUTION].

#### Question 6 (421/521)

Consider two curves $\hat{g}1$ and $\hat{g}2$, defined by

  $$
  \hat{g}1 = \arg\min_{g}(\sum_{i=1}^n (y_i - g(x_i))^2 +  \lambda \int [g^{(3)} (x)]^2 dx )
  $$
  
  $$
  \hat{g}2 = \arg\min_{g}(\sum_{i=1}^n (y_i - g(x_i))^2 +  \lambda \int [g^{(4)} (x)]^2 dx )
  $$
  
 
where $g^{(m)}$ represents the $m^{th}$ derivative of $g$. Now, answer the following questions (and include a brief explanation):

  a) As $\lambda \rightarrow \infty$, will $\hat{g}1$ or $\hat{g}2$ have smaller training RSS?
  
  > **_Answer:_**  [BEGIN SOLUTION].
  
  b) As $\lambda \rightarrow \infty$, will $\hat{g}1$ or $\hat{g}2$ have smaller test RSS?
  
  > **_Answer:_**  [BEGIN SOLUTION].
  
  c) For $\lambda= 0$, will $\hat{g}1$ or $\hat{g}2$ have smaller training RSS?
  
  > **_Answer:_**  [BEGIN SOLUTION].


## Applied

Please note that some of the questions outlined below make suggestions on potential functions to be used in the answers. Unless indicated otherwise, feel free to use any other function. For those interested in improving their R skills, I would recommend going over the information in the following book for _tidyverse_ (https://emilhvitfeldt.github.io/ISLR-tidymodels-labs/linear-regression.html), using _caret_ to answer some of the questions (https://topepo.github.io/caret/), or _mikropml_ (https://cran.r-project.org/web/packages/mikropml/vignettes/introduction.html)

#### Question 7 (421/521)
```{r message=FALSE}
# load libraries
library(ISLR2)
library(caret)
library(leaps)
library(tidyverse)
library(ggthemes)
library(broom)
library(knitr)
library(gam)
library(maps) 
```

This question relates to the `College` data set.

a) Split the data into a training set and a test set (50:50). Using out-of-state tuition as the response and the other variables as the predictors, perform *forward* stepwise selection on the training set in order to identify a satisfactory model that uses just a subset of the predictors.

```{r}
# BEGIN SOLUTION
College <- read.csv("https://book.huihoo.com/introduction-to-statistical-learning/College.csv")

# replace first row X with college names
College <- College[,-1]

# partition the data
inTrain <- createDataPartition(College$Outstate, p = 0.5, list = FALSE)

training <- College[inTrain,]
testing <- College[-inTrain,]

dummy_matrix <- model.matrix(Outstate ~ ., data = training)

forward_model <- regsubsets(x = dummy_matrix, y = training$Outstate,
                            method = 'forward', nvmax = 17)

# Analyze models fitted with the subsets
fit_summary <- summary(forward_model)
# fit_summary

# plot of the RMSE, Cp, BIC, and R^2
data_frame(RMSE = sqrt(fit_summary$rss/nrow(training)),
           Cp = fit_summary$cp, 
           BIC = fit_summary$bic,
           AdjustedR2 = fit_summary$adjr2) %>%
    mutate(id = row_number()) %>%
    gather(Metric, value, -id) %>%
    ggplot(aes(id, value, col = Metric)) +
    geom_line() + 
    geom_point() + 
    labs(x = 'Number of Variables Used', y = '') + 
    facet_wrap(~ Metric, scales = 'free') +
    scale_x_continuous(breaks = 1:17)

# model with selected variables
options(knitr.kable.NA = '')
num_coefs <- rep(NA, 12)
for (i in 1:12){
    nam <- names(coef(forward_model, id = i))
    nam <- nam[!grepl(pattern = 'Intercept', x = nam)]
    num_coefs[i] <- length(nam) + 1
}

coef(forward_model, id = 1:12) %>%
    map(names) %>%
    map(function(x) x[!grepl(pattern = 'Intercept', x = x)]) %>%
    map(paste, collapse = ' + ') %>%
    map(function(x) paste('Outstate', x, sep = ' ~ ')) %>%
    map(as.formula) %>%
    map(function(x) lm(formula = x, data = training)) %>%
    map(tidy) %>%
    reduce(rbind) %>%
    mutate(num.covs = rep(1:12, num_coefs),
           estimate = round(estimate, digits = 2),
           estimate = ifelse(p.value < 0.05,
                             paste0(estimate, '**'),
                             estimate)) %>%
    select(num.covs, term, estimate) %>%
    spread(num.covs, estimate) %>%
    filter(!grepl('Intercept', term)) %>%
    kable()

# identify useful variables 
keyvar <- data.matrix(College[, c("Apps", "perc.alumni", "Personal","PhD","S.F.Ratio", "Top25perc", "Outstate", "Room.Board", "Expend", "Grad.Rate")])

# END SOLUTION
```


b) Fit a GAM on the training data, using out-of-state tuition as the response and the features selected in the previous step as the predictors. Plot the results, and briefly explain your findings.

```{r}
# BEGIN SOLUTION
# library(gam)
coefs <- names(coef(forward_model, id = 6))
coefs <- coefs[-grep('Intercept', coefs)]

gam_model <- train(x = training[,coefs], y = training$Outstate,
                   method = 'gamSpline',
                   trControl = trainControl(method = 'cv', number = 10),
                   tuneGrid = expand.grid(df = 1:10))
plot(gam_model)
# END SOLUTION
```
The optimal df is 3 based on 10 fold CV. 

c) For which variables, if any, is there evidence of a non-linear relationship with the response?

```{r}
# BEGIN SOLUTION

# END SOLUTION
```


#### Question 8 (521)

Answer the questions below using the following dataset:

```{r eval = F}
# Change eval=FALSE to TRUE once HW.RData is in the same folder as this script.
load("HW.RData")
```

  a) Only by inspecting the plots shown below: Is there any temporal or spatial trend in the response variable `richness`?

```{r eval=F, message=FALSE}
# library(maps) #Install if needed
# library(tidyverse) #Iuploaded earlier
head(data)
ggplot(aes(x=Year,y=richness),data=data)+geom_point()+
  theme_bw()
ggplot(aes(x=Longitude,y=Latitude,col=richness), data=data) +
  geom_polygon(data=map,fill=NA, col="black")+
  geom_point()+theme_bw()
```

  b) Now, fit a Poisson GAM with the following structure `E(richness) = exp(f(year))*exp(g(location))`. Note that location is actually two features: `Longitude` and `Latitude.` Name this model `M1.` Plot the model (`plot(M1, scheme=2)`), get the `summary` of `M1`, and answer: Is there evidence for effects of location and year?

```{r}
# BEGIN SOLUTION
# Poisson GAM 
#E(richness) = exp(f(year))*exp(g(location))

# END SOLUTION
```


  c) Now, fit another Poisson GAM model with the same structure as in `M1` but using `ti()` to account for the interactions between `longitude`, `latitude`, and `year.` Ideally, use `d=c(2,1)` as argument to `ti()`.

```{r}
# BEGIN SOLUTION

# END SOLUTION
```

d) Use an ANOVA to compare `M1` and `M2.` Which model should we select based on this test?

```{r}
# BEGIN SOLUTION

# END SOLUTION
```


e) Finally, can you come up with a simple approach to examine which of the features (`latitude`, `longitude`, or `year`) have a larger impact on the response (`richness`) using GAMs?

```{r}
# BEGIN SOLUTION

# END SOLUTION
```


